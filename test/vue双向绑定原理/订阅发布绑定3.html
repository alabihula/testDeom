<!DOCTYPE html>
<html>

	<head>
		<meta charset="UTF-8">
		<title></title>
	</head>

	<body>
		<div id="app">
			<input type="text" name="aaa" id="aaa" v-model="aaa" />
			<div id="bbb">{{aaa}}</div>
		</div>
	</body>
	<script type="text/javascript">
		//主题
		var Dep = function() {
			this.subs = [];
			this.add = function(sub) {
				this.subs.push(sub);
			}
		}
		//主题定义执行方法
		Dep.prototype.notify = function() {
			this.subs.forEach(function(sub) {
				sub.update();
			})
		}
		
		//定义订阅者
		var Watcher = function(name,update) {
			Dep.target = this;
			this.update = update;
			this.update();
			Dep.target = null;
		}
		function Vue(options) {
			this.data = options.data;
			var idName = options.el.split("#")[1];
			var el = document.getElementById(idName);
			if(options.el.indexOf("#") == -1) {
				var className = options.el.split(".")[1];
				el = document.getElementsByClassName(className)[0];
			}
			
			//为每个data中参数绑定set和get方法，并设定初始值
			observe(this.data,this);
			
			//劫持指定元素下的全部节点，并且解析其中的vue标签并且赋值初始值
			var fragment = copyNodes(el, this);
			el.appendChild(fragment);
		}
		var app = new Vue({
			el: "#app",
			data: {
				aaa: "测试数据",
				str:222
			}
		})

		function observe(objCopy,obj) {
			Object.keys(objCopy).forEach(function(key) {
				defineReactive(obj,key,objCopy[key]);
			})
		}
		
		//为obj定义set和get方法
		function defineReactive(obj, key, val) {
			var dep = new Dep();
			Object.defineProperty(obj,key,{
				get: function() {
					if(Dep.target) dep.add(Dep.target);
					return val;
				},
				set: function(newVal) {//给vue中data设置值的时候访问
					if(newVal == val) return;
					val = newVal;
					console.log(val);
					dep.notify();
				}
			})
		}
		
		//复制和劫持所有节点重新输入到指定元素中
		function copyNodes(el, app) {
			var fragment = document.createDocumentFragment();
			var child = null;
			while(child = el.firstChild) {
				sysNode(child, app);
				fragment.appendChild(child);
			}
			return fragment;
		}
		
		//解析 vue的字符指令 ，绑定初始数据
		function sysNode(node, vue) {
			//解析{{}}
			var reg = /\{\{(.*)\}\}/;
			//替换属性
			if(node.nodeType === 1) { //元素
				var attributes = node.attributes;
				for(var i = 0; i < attributes.length; i++) {
					var nodeName = attributes[i].nodeName;
					if(nodeName == "v-model") {
						var nodeValue = attributes[i].nodeValue;
						
						node.addEventListener("input",function(e) {
							vue[nodeValue] = e.target.value;
						})
						node.removeAttribute("v-model"); //删除v-model
						
						//为主题加入订阅者
						var watcher = new Watcher(nodeValue,function() {
							node.value = vue[nodeValue];
						});
					}
				}
				//解析元素中的{{}}
				if(reg.test(node.innerHTML)) {
					var name = RegExp.$1;
					name = name.trim();
					
					var watcher = new Watcher(name,function() {
						node.innerHTML = vue[name];
					});
				}
			}
		}
		
	</script>

</html>